{"expireTime":9007200889996144000,"key":"gatsby-plugin-mdx-entire-payload-428cec581e49270a1d4076d2366b9fc0-","val":{"mdast":{"type":"root","children":[{"type":"heading","depth":1,"children":[{"type":"text","value":"Zone Analytics Colos Endpoint to GraphQL Analytics","position":{"start":{"line":1,"column":3,"offset":2},"end":{"line":1,"column":53,"offset":52},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":1,"column":53,"offset":52},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"This guide shows how you might migrate from the deprecated (and soon to be\nsunset) zone analytics API to the GraphQL API. It provides an example for a\nplausible use-case of the colos endpoint, then shows how that use-case is\ntranslated to the GraphQL API. It also explores features of the GraphQL API\nthat make it more powerful than the API it replaces.","position":{"start":{"line":3,"column":1,"offset":54},"end":{"line":7,"column":53,"offset":407},"indent":[1,1,1,1]}}],"position":{"start":{"line":3,"column":1,"offset":54},"end":{"line":7,"column":53,"offset":407},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"In this example, we want to calculate the number of requests for a particular\ncolo, broken down by the hour in which the requests occurred. Referring to the\nzone analytics colos endpoint, we can construct a \"curl\" which retrieves the\ndata from the API.","position":{"start":{"line":9,"column":1,"offset":409},"end":{"line":12,"column":19,"offset":661},"indent":[1,1,1]}}],"position":{"start":{"line":9,"column":1,"offset":409},"end":{"line":12,"column":19,"offset":661},"indent":[1,1,1]}},{"type":"code","lang":"bash","meta":null,"value":"curl -H \"Authorization: Bearer $API_TOKEN\" \"https://api.cloudflare.com/client/v4/zones/$ZONE_ID/analytics/colos?since=2020-12-10T00:00:00Z\"  > colos_endpoint_output.json","position":{"start":{"line":14,"column":1,"offset":663},"end":{"line":16,"column":4,"offset":844},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This query says:","position":{"start":{"line":18,"column":1,"offset":846},"end":{"line":18,"column":17,"offset":862},"indent":[]}}],"position":{"start":{"line":18,"column":1,"offset":846},"end":{"line":18,"column":17,"offset":862},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Given an ","position":{"start":{"line":20,"column":3,"offset":866},"end":{"line":20,"column":12,"offset":875},"indent":[]}},{"type":"inlineCode","value":"API_TOKEN","position":{"start":{"line":20,"column":12,"offset":875},"end":{"line":20,"column":23,"offset":886},"indent":[]}},{"type":"text","value":" which has Analytics Read access to ","position":{"start":{"line":20,"column":23,"offset":886},"end":{"line":20,"column":59,"offset":922},"indent":[]}},{"type":"inlineCode","value":"ZONE_ID","position":{"start":{"line":20,"column":59,"offset":922},"end":{"line":20,"column":68,"offset":931},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":20,"column":68,"offset":931},"end":{"line":20,"column":69,"offset":932},"indent":[]}}],"position":{"start":{"line":20,"column":3,"offset":866},"end":{"line":20,"column":69,"offset":932},"indent":[]}}],"position":{"start":{"line":20,"column":1,"offset":864},"end":{"line":20,"column":69,"offset":932},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Fetch colos analytics for ","position":{"start":{"line":21,"column":3,"offset":935},"end":{"line":21,"column":29,"offset":961},"indent":[]}},{"type":"inlineCode","value":"ZONE_ID","position":{"start":{"line":21,"column":29,"offset":961},"end":{"line":21,"column":38,"offset":970},"indent":[]}},{"type":"text","value":" with a time range that starts on\n","position":{"start":{"line":21,"column":38,"offset":970},"end":{"line":22,"column":3,"offset":1006},"indent":[3]}},{"type":"inlineCode","value":"2020-12-10T00:00:00Z","position":{"start":{"line":22,"column":3,"offset":1006},"end":{"line":22,"column":25,"offset":1028},"indent":[]}},{"type":"text","value":" (","position":{"start":{"line":22,"column":25,"offset":1028},"end":{"line":22,"column":27,"offset":1030},"indent":[]}},{"type":"inlineCode","value":"since","position":{"start":{"line":22,"column":27,"offset":1030},"end":{"line":22,"column":34,"offset":1037},"indent":[]}},{"type":"text","value":" paramenter) to now.","position":{"start":{"line":22,"column":34,"offset":1037},"end":{"line":22,"column":54,"offset":1057},"indent":[]}}],"position":{"start":{"line":21,"column":3,"offset":935},"end":{"line":22,"column":54,"offset":1057},"indent":[3]}}],"position":{"start":{"line":21,"column":1,"offset":933},"end":{"line":22,"column":54,"offset":1057},"indent":[1]}}],"position":{"start":{"line":20,"column":1,"offset":864},"end":{"line":22,"column":54,"offset":1057},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"The question that we want to answer is: \"what is the number of requests for ZHR\nper hour?\" Using the colos endpoint response data and some wrangling by jq we\ncan answer that question with this command:","position":{"start":{"line":24,"column":1,"offset":1059},"end":{"line":26,"column":44,"offset":1260},"indent":[1,1]}}],"position":{"start":{"line":24,"column":1,"offset":1059},"end":{"line":26,"column":44,"offset":1260},"indent":[1,1]}},{"type":"code","lang":"bash","meta":null,"value":"cat colos_endpoint_output.json | jq  -c '.result[] | {colo_id: .colo_id, timeseries: .timeseries[]} | {colo_id: .colo_id, timeslot: .timeseries.since, requests: .timeseries.requests.all, bandwidth: .timeseries.bandwidth.all} | select(.requests > 0) | select(.colo_id == \"ZRH\") '","position":{"start":{"line":28,"column":1,"offset":1262},"end":{"line":30,"column":4,"offset":1552},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This jq command is a bit of a mouthful, so let's break it down:","position":{"start":{"line":32,"column":1,"offset":1554},"end":{"line":32,"column":64,"offset":1617},"indent":[]}}],"position":{"start":{"line":32,"column":1,"offset":1554},"end":{"line":32,"column":64,"offset":1617},"indent":[]}},{"type":"code","lang":"bash","meta":null,"value":".result[]","position":{"start":{"line":34,"column":1,"offset":1619},"end":{"line":36,"column":4,"offset":1640},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This means \"break out the result array into individual json lines\"","position":{"start":{"line":38,"column":1,"offset":1642},"end":{"line":38,"column":67,"offset":1708},"indent":[]}}],"position":{"start":{"line":38,"column":1,"offset":1642},"end":{"line":38,"column":67,"offset":1708},"indent":[]}},{"type":"code","lang":"bash","meta":null,"value":"{colo_id: .colo_id, timeseries: .timeseries[]}","position":{"start":{"line":40,"column":1,"offset":1710},"end":{"line":42,"column":4,"offset":1768},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This breaks out each json line into multiple json lines. Each resulting line\ncontains a ","position":{"start":{"line":44,"column":1,"offset":1770},"end":{"line":45,"column":12,"offset":1858},"indent":[1]}},{"type":"inlineCode","value":"colo_id","position":{"start":{"line":45,"column":12,"offset":1858},"end":{"line":45,"column":21,"offset":1867},"indent":[]}},{"type":"text","value":" and one element of the ","position":{"start":{"line":45,"column":21,"offset":1867},"end":{"line":45,"column":45,"offset":1891},"indent":[]}},{"type":"inlineCode","value":"timeseries","position":{"start":{"line":45,"column":45,"offset":1891},"end":{"line":45,"column":57,"offset":1903},"indent":[]}},{"type":"text","value":" array. ","position":{"start":{"line":45,"column":57,"offset":1903},"end":{"line":45,"column":65,"offset":1911},"indent":[]}}],"position":{"start":{"line":44,"column":1,"offset":1770},"end":{"line":45,"column":65,"offset":1911},"indent":[1]}},{"type":"code","lang":"bash","meta":null,"value":"{colo_id: .colo_id, timeslot: .timeseries.since, requests: .timeseries.requests.all, bandwidth: .timeseries.bandwidth.all}","position":{"start":{"line":47,"column":1,"offset":1913},"end":{"line":49,"column":4,"offset":2047},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This flattens out the data we are interested in that is inside the timeseries\nobject of each line.","position":{"start":{"line":51,"column":1,"offset":2049},"end":{"line":52,"column":21,"offset":2147},"indent":[1]}}],"position":{"start":{"line":51,"column":1,"offset":2049},"end":{"line":52,"column":21,"offset":2147},"indent":[1]}},{"type":"code","lang":"bash","meta":null,"value":"select(.requests > 0) | select(.colo_id == \"ZRH\")","position":{"start":{"line":54,"column":1,"offset":2149},"end":{"line":56,"column":4,"offset":2210},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This selects only lines that contain more than 0 requests and the ","position":{"start":{"line":58,"column":1,"offset":2212},"end":{"line":58,"column":67,"offset":2278},"indent":[]}},{"type":"inlineCode","value":"colo_id","position":{"start":{"line":58,"column":67,"offset":2278},"end":{"line":58,"column":76,"offset":2287},"indent":[]}},{"type":"text","value":" is ZRH.","position":{"start":{"line":58,"column":76,"offset":2287},"end":{"line":58,"column":84,"offset":2295},"indent":[]}}],"position":{"start":{"line":58,"column":1,"offset":2212},"end":{"line":58,"column":84,"offset":2295},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"So the final data we get looks something like this:","position":{"start":{"line":60,"column":1,"offset":2297},"end":{"line":60,"column":52,"offset":2348},"indent":[]}}],"position":{"start":{"line":60,"column":1,"offset":2297},"end":{"line":60,"column":52,"offset":2348},"indent":[]}},{"type":"jsx","value":"<details>\n<summary>Response</summary>\n<div>","position":{"start":{"line":62,"column":1,"offset":2350},"end":{"line":64,"column":6,"offset":2393},"indent":[1,1]}},{"type":"code","lang":"json","meta":null,"value":"{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T00:00:00Z\",\"requests\":601,\"bandwidth\":683581}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T01:00:00Z\",\"requests\":484,\"bandwidth\":550936}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T02:00:00Z\",\"requests\":326,\"bandwidth\":370627}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T03:00:00Z\",\"requests\":354,\"bandwidth\":402527}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T04:00:00Z\",\"requests\":446,\"bandwidth\":507234}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T05:00:00Z\",\"requests\":692,\"bandwidth\":787688}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T06:00:00Z\",\"requests\":1474,\"bandwidth\":1676166}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T07:00:00Z\",\"requests\":2839,\"bandwidth\":3226871}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T08:00:00Z\",\"requests\":2953,\"bandwidth\":3358487}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T09:00:00Z\",\"requests\":2550,\"bandwidth\":2901823}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T10:00:00Z\",\"requests\":2203,\"bandwidth\":2504615}\n...","position":{"start":{"line":66,"column":1,"offset":2395},"end":{"line":79,"column":4,"offset":3366},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"jsx","value":"</div>\n</details>","position":{"start":{"line":81,"column":1,"offset":3368},"end":{"line":82,"column":11,"offset":3385},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"So, how do we do the same thing using the GraphQL API?","position":{"start":{"line":84,"column":1,"offset":3387},"end":{"line":84,"column":55,"offset":3441},"indent":[]}}],"position":{"start":{"line":84,"column":1,"offset":3387},"end":{"line":84,"column":55,"offset":3441},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"The GraphQL API allows us to be much more specific about the data that we want\nto retrieve. While the colos endpoint forces us to retrieve all the information\nis has about the breakdown of requests and bandwidth per colo, using the\nGraphQL API allows us to fetch only the information we are interested in.","position":{"start":{"line":86,"column":1,"offset":3443},"end":{"line":89,"column":74,"offset":3748},"indent":[1,1,1]}}],"position":{"start":{"line":86,"column":1,"offset":3443},"end":{"line":89,"column":74,"offset":3748},"indent":[1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"The data we want is about HTTP requests. Hence, we use the canonical source for\nHTTP request data, also known as ","position":{"start":{"line":91,"column":1,"offset":3750},"end":{"line":92,"column":34,"offset":3863},"indent":[1]}},{"type":"inlineCode","value":"httpRequestsAdaptiveGroups","position":{"start":{"line":92,"column":34,"offset":3863},"end":{"line":92,"column":62,"offset":3891},"indent":[]}},{"type":"text","value":". This node in\nGraphQL API allows you to filter and group by almost any dimension of an http\nrequest imaginable. It is \"Adaptive\" so responses will be fast since it is\ndriven by our \n","position":{"start":{"line":92,"column":62,"offset":3891},"end":{"line":96,"column":1,"offset":4074},"indent":[1,1,1,1]}},{"type":"link","title":null,"url":"https://blog.cloudflare.com/explaining-cloudflares-abr-analytics/","children":[{"type":"text","value":"\"ABR\" technology","position":{"start":{"line":96,"column":2,"offset":4075},"end":{"line":96,"column":18,"offset":4091},"indent":[]}}],"position":{"start":{"line":96,"column":1,"offset":4074},"end":{"line":96,"column":86,"offset":4159},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":96,"column":86,"offset":4159},"end":{"line":96,"column":87,"offset":4160},"indent":[]}}],"position":{"start":{"line":91,"column":1,"offset":3750},"end":{"line":96,"column":87,"offset":4160},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Let's craft a GraphQL API query to retrieve the data we need to answer the\nquestion: \"what is the number of requests for ZHR per hour?\" ","position":{"start":{"line":98,"column":1,"offset":4162},"end":{"line":99,"column":62,"offset":4298},"indent":[1]}}],"position":{"start":{"line":98,"column":1,"offset":4162},"end":{"line":99,"column":62,"offset":4298},"indent":[1]}},{"type":"code","lang":"text","meta":null,"value":"{\n  viewer {\n    zones(filter: {zoneTag:\"$ZONE_TAG\"}) {\n      httpRequestsAdaptiveGroups(filter: {datetime_gt: \"2020-12-10T00:00:00Z\", coloCode:\"ZRH\"}, limit:10000, orderBy: [datetimeHour_ASC]) {\n        count\n        sum {\n          edgeResponseBytes\n        }\n        avg {\n          sampleInterval\n        }\n        count\n        dimensions {\n          datetimeHour\n          coloCode\n        }\n      }\n    }\n  }\n}","position":{"start":{"line":101,"column":1,"offset":4300},"end":{"line":122,"column":4,"offset":4729},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Then we can run it with \"curl\":","position":{"start":{"line":124,"column":1,"offset":4731},"end":{"line":124,"column":32,"offset":4762},"indent":[]}}],"position":{"start":{"line":124,"column":1,"offset":4731},"end":{"line":124,"column":32,"offset":4762},"indent":[]}},{"type":"code","lang":"bash","meta":null,"value":"curl -X POST -H 'Authorization: Bearer $API_TOKEN'  https://api.cloudflare.com/client/v4/graphql -d \"@./coloGroups.json\" > graphqlColoGroupsResponse.json","position":{"start":{"line":126,"column":1,"offset":4764},"end":{"line":128,"column":4,"offset":4929},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"We can answer our question in the same way as before using jq:","position":{"start":{"line":130,"column":1,"offset":4931},"end":{"line":130,"column":63,"offset":4993},"indent":[]}}],"position":{"start":{"line":130,"column":1,"offset":4931},"end":{"line":130,"column":63,"offset":4993},"indent":[]}},{"type":"code","lang":"bash","meta":null,"value":"cat graphqlColoGroupsResponse.json| jq -c '.data.viewer.zones[] | .httpRequestsAdaptiveGroups[] | {colo_id: .dimensions.coloCode, timeslot: .dimensions.datetimeHour, requests: .count, bandwidth: .sum.edgeResponseBytes}'","position":{"start":{"line":132,"column":1,"offset":4995},"end":{"line":134,"column":4,"offset":5226},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This command is much simpler than what we had before, because the data returned\nby the GraphQL API is much simpler than what is returned by the colos endpoint.","position":{"start":{"line":136,"column":1,"offset":5228},"end":{"line":137,"column":80,"offset":5387},"indent":[1]}}],"position":{"start":{"line":136,"column":1,"offset":5228},"end":{"line":137,"column":80,"offset":5387},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"Still, it is worth explaining the command since it will help to understand some\nof the concepts underlying the GraphQL API.","position":{"start":{"line":139,"column":1,"offset":5389},"end":{"line":140,"column":44,"offset":5512},"indent":[1]}}],"position":{"start":{"line":139,"column":1,"offset":5389},"end":{"line":140,"column":44,"offset":5512},"indent":[1]}},{"type":"code","lang":"bash","meta":null,"value":".data.viewer.zones[]","position":{"start":{"line":142,"column":1,"offset":5514},"end":{"line":144,"column":4,"offset":5546},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"The format of a GraphQL response is much the same as the query. A successful\nresponse always contains a \"data\" object which wraps the data in the response.\nA query will always have a \"viewer\" object which represents your user. Then, we\nunwrap the zones objects, one per line. Our query only has one zone (since this\nis how we chose to do it). But a query could have multiple zones as well. ","position":{"start":{"line":146,"column":1,"offset":5548},"end":{"line":150,"column":75,"offset":5938},"indent":[1,1,1,1]}}],"position":{"start":{"line":146,"column":1,"offset":5548},"end":{"line":150,"column":75,"offset":5938},"indent":[1,1,1,1]}},{"type":"code","lang":"bash","meta":null,"value":".httpRequestsAdaptiveGroups[]","position":{"start":{"line":152,"column":1,"offset":5940},"end":{"line":154,"column":4,"offset":5981},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"The httpRequestsAdaptiveGroups field is a list, where each datapoint in the\nlist represents a combination of the dimensions that were selected, along with\nthe aggregation that was selected for that combination of the dimensions. Here,\nwe unwrap each of the datapoints, one per row.","position":{"start":{"line":156,"column":1,"offset":5983},"end":{"line":159,"column":47,"offset":6264},"indent":[1,1,1]}}],"position":{"start":{"line":156,"column":1,"offset":5983},"end":{"line":159,"column":47,"offset":6264},"indent":[1,1,1]}},{"type":"code","lang":"bash","meta":null,"value":"{colo_id: .dimensions.coloCode, timeslot: .dimensions.datetimeHour, requests: .count, bandwidth: .sum.edgeResponseBytes}","position":{"start":{"line":161,"column":1,"offset":6266},"end":{"line":163,"column":4,"offset":6398},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This is straightforward: it just selects the attributes of each datapoint that\nwe are interested in, in the format which we used previously in the colos\nendpoint.","position":{"start":{"line":165,"column":1,"offset":6400},"end":{"line":167,"column":10,"offset":6562},"indent":[1,1]}}],"position":{"start":{"line":165,"column":1,"offset":6400},"end":{"line":167,"column":10,"offset":6562},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"The GraphQL API is so much more powerful than this, though. You can filter and\ngroup the data by any dimensions you can think of. This feature is totally\nabsent from the colos endpoint in the Zone Analytics API.","position":{"start":{"line":169,"column":1,"offset":6564},"end":{"line":171,"column":58,"offset":6775},"indent":[1,1]}}],"position":{"start":{"line":169,"column":1,"offset":6564},"end":{"line":171,"column":58,"offset":6775},"indent":[1,1]}},{"type":"export","value":"export const _frontmatter = {\"order\":12,\"pcx-content-type\":\"reference\"}","position":{"start":{"line":174,"column":1,"offset":6778},"end":{"line":174,"column":72,"offset":6849},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":174,"column":72,"offset":6849}}},"scopeImports":["import * as React from 'react'"],"scopeIdentifiers":["React"],"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"order\": 12,\n  \"pcx-content-type\": \"reference\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", {\n    \"id\": \"zone-analytics-colos-endpoint-to-graphql-analytics\"\n  }, \"Zone Analytics Colos Endpoint to GraphQL Analytics\"), mdx(\"p\", null, \"This guide shows how you might migrate from the deprecated (and soon to be\\nsunset) zone analytics API to the GraphQL API. It provides an example for a\\nplausible use-case of the colos endpoint, then shows how that use-case is\\ntranslated to the GraphQL API. It also explores features of the GraphQL API\\nthat make it more powerful than the API it replaces.\"), mdx(\"p\", null, \"In this example, we want to calculate the number of requests for a particular\\ncolo, broken down by the hour in which the requests occurred. Referring to the\\nzone analytics colos endpoint, we can construct a \\\"curl\\\" which retrieves the\\ndata from the API.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"curl -H \\\"Authorization: Bearer $API_TOKEN\\\" \\\"https://api.cloudflare.com/client/v4/zones/$ZONE_ID/analytics/colos?since=2020-12-10T00:00:00Z\\\"  > colos_endpoint_output.json\\n\")), mdx(\"p\", null, \"This query says:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Given an \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"API_TOKEN\"), \" which has Analytics Read access to \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"ZONE_ID\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Fetch colos analytics for \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"ZONE_ID\"), \" with a time range that starts on\\n\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"2020-12-10T00:00:00Z\"), \" (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"since\"), \" paramenter) to now.\")), mdx(\"p\", null, \"The question that we want to answer is: \\\"what is the number of requests for ZHR\\nper hour?\\\" Using the colos endpoint response data and some wrangling by jq we\\ncan answer that question with this command:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"cat colos_endpoint_output.json | jq  -c '.result[] | {colo_id: .colo_id, timeseries: .timeseries[]} | {colo_id: .colo_id, timeslot: .timeseries.since, requests: .timeseries.requests.all, bandwidth: .timeseries.bandwidth.all} | select(.requests > 0) | select(.colo_id == \\\"ZRH\\\") '\\n\")), mdx(\"p\", null, \"This jq command is a bit of a mouthful, so let's break it down:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \".result[]\\n\")), mdx(\"p\", null, \"This means \\\"break out the result array into individual json lines\\\"\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"{colo_id: .colo_id, timeseries: .timeseries[]}\\n\")), mdx(\"p\", null, \"This breaks out each json line into multiple json lines. Each resulting line\\ncontains a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"colo_id\"), \" and one element of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"timeseries\"), \" array. \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"{colo_id: .colo_id, timeslot: .timeseries.since, requests: .timeseries.requests.all, bandwidth: .timeseries.bandwidth.all}\\n\")), mdx(\"p\", null, \"This flattens out the data we are interested in that is inside the timeseries\\nobject of each line.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"select(.requests > 0) | select(.colo_id == \\\"ZRH\\\")\\n\")), mdx(\"p\", null, \"This selects only lines that contain more than 0 requests and the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"colo_id\"), \" is ZRH.\"), mdx(\"p\", null, \"So the final data we get looks something like this:\"), mdx(\"details\", null, mdx(\"summary\", null, \"Response\"), mdx(\"div\", null, mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T00:00:00Z\\\",\\\"requests\\\":601,\\\"bandwidth\\\":683581}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T01:00:00Z\\\",\\\"requests\\\":484,\\\"bandwidth\\\":550936}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T02:00:00Z\\\",\\\"requests\\\":326,\\\"bandwidth\\\":370627}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T03:00:00Z\\\",\\\"requests\\\":354,\\\"bandwidth\\\":402527}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T04:00:00Z\\\",\\\"requests\\\":446,\\\"bandwidth\\\":507234}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T05:00:00Z\\\",\\\"requests\\\":692,\\\"bandwidth\\\":787688}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T06:00:00Z\\\",\\\"requests\\\":1474,\\\"bandwidth\\\":1676166}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T07:00:00Z\\\",\\\"requests\\\":2839,\\\"bandwidth\\\":3226871}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T08:00:00Z\\\",\\\"requests\\\":2953,\\\"bandwidth\\\":3358487}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T09:00:00Z\\\",\\\"requests\\\":2550,\\\"bandwidth\\\":2901823}\\n{\\\"colo_id\\\":\\\"ZRH\\\",\\\"timeslot\\\":\\\"2020-12-10T10:00:00Z\\\",\\\"requests\\\":2203,\\\"bandwidth\\\":2504615}\\n...\\n\")))), mdx(\"p\", null, \"So, how do we do the same thing using the GraphQL API?\"), mdx(\"p\", null, \"The GraphQL API allows us to be much more specific about the data that we want\\nto retrieve. While the colos endpoint forces us to retrieve all the information\\nis has about the breakdown of requests and bandwidth per colo, using the\\nGraphQL API allows us to fetch only the information we are interested in.\"), mdx(\"p\", null, \"The data we want is about HTTP requests. Hence, we use the canonical source for\\nHTTP request data, also known as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"httpRequestsAdaptiveGroups\"), \". This node in\\nGraphQL API allows you to filter and group by almost any dimension of an http\\nrequest imaginable. It is \\\"Adaptive\\\" so responses will be fast since it is\\ndriven by our\\n\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://blog.cloudflare.com/explaining-cloudflares-abr-analytics/\"\n  }, \"\\\"ABR\\\" technology\"), \".\"), mdx(\"p\", null, \"Let's craft a GraphQL API query to retrieve the data we need to answer the\\nquestion: \\\"what is the number of requests for ZHR per hour?\\\" \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"{\\n  viewer {\\n    zones(filter: {zoneTag:\\\"$ZONE_TAG\\\"}) {\\n      httpRequestsAdaptiveGroups(filter: {datetime_gt: \\\"2020-12-10T00:00:00Z\\\", coloCode:\\\"ZRH\\\"}, limit:10000, orderBy: [datetimeHour_ASC]) {\\n        count\\n        sum {\\n          edgeResponseBytes\\n        }\\n        avg {\\n          sampleInterval\\n        }\\n        count\\n        dimensions {\\n          datetimeHour\\n          coloCode\\n        }\\n      }\\n    }\\n  }\\n}\\n\")), mdx(\"p\", null, \"Then we can run it with \\\"curl\\\":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"curl -X POST -H 'Authorization: Bearer $API_TOKEN'  https://api.cloudflare.com/client/v4/graphql -d \\\"@./coloGroups.json\\\" > graphqlColoGroupsResponse.json\\n\")), mdx(\"p\", null, \"We can answer our question in the same way as before using jq:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"cat graphqlColoGroupsResponse.json| jq -c '.data.viewer.zones[] | .httpRequestsAdaptiveGroups[] | {colo_id: .dimensions.coloCode, timeslot: .dimensions.datetimeHour, requests: .count, bandwidth: .sum.edgeResponseBytes}'\\n\")), mdx(\"p\", null, \"This command is much simpler than what we had before, because the data returned\\nby the GraphQL API is much simpler than what is returned by the colos endpoint.\"), mdx(\"p\", null, \"Still, it is worth explaining the command since it will help to understand some\\nof the concepts underlying the GraphQL API.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \".data.viewer.zones[]\\n\")), mdx(\"p\", null, \"The format of a GraphQL response is much the same as the query. A successful\\nresponse always contains a \\\"data\\\" object which wraps the data in the response.\\nA query will always have a \\\"viewer\\\" object which represents your user. Then, we\\nunwrap the zones objects, one per line. Our query only has one zone (since this\\nis how we chose to do it). But a query could have multiple zones as well. \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \".httpRequestsAdaptiveGroups[]\\n\")), mdx(\"p\", null, \"The httpRequestsAdaptiveGroups field is a list, where each datapoint in the\\nlist represents a combination of the dimensions that were selected, along with\\nthe aggregation that was selected for that combination of the dimensions. Here,\\nwe unwrap each of the datapoints, one per row.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"{colo_id: .dimensions.coloCode, timeslot: .dimensions.datetimeHour, requests: .count, bandwidth: .sum.edgeResponseBytes}\\n\")), mdx(\"p\", null, \"This is straightforward: it just selects the attributes of each datapoint that\\nwe are interested in, in the format which we used previously in the colos\\nendpoint.\"), mdx(\"p\", null, \"The GraphQL API is so much more powerful than this, though. You can filter and\\ngroup the data by any dimensions you can think of. This feature is totally\\nabsent from the colos endpoint in the Zone Analytics API.\"));\n}\n;\nMDXContent.isMDXComponent = true;","rawMDXOutput":"/* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nexport const _frontmatter = {\n  \"order\": 12,\n  \"pcx-content-type\": \"reference\"\n};\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\")\n  return <div {...props}/>\n};\n\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n    <h1 {...{\n      \"id\": \"zone-analytics-colos-endpoint-to-graphql-analytics\"\n    }}>{`Zone Analytics Colos Endpoint to GraphQL Analytics`}</h1>\n    <p>{`This guide shows how you might migrate from the deprecated (and soon to be\nsunset) zone analytics API to the GraphQL API. It provides an example for a\nplausible use-case of the colos endpoint, then shows how that use-case is\ntranslated to the GraphQL API. It also explores features of the GraphQL API\nthat make it more powerful than the API it replaces.`}</p>\n    <p>{`In this example, we want to calculate the number of requests for a particular\ncolo, broken down by the hour in which the requests occurred. Referring to the\nzone analytics colos endpoint, we can construct a \"curl\" which retrieves the\ndata from the API.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`curl -H \"Authorization: Bearer $API_TOKEN\" \"https://api.cloudflare.com/client/v4/zones/$ZONE_ID/analytics/colos?since=2020-12-10T00:00:00Z\"  > colos_endpoint_output.json\n`}</code></pre>\n    <p>{`This query says:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Given an `}<inlineCode parentName=\"li\">{`API_TOKEN`}</inlineCode>{` which has Analytics Read access to `}<inlineCode parentName=\"li\">{`ZONE_ID`}</inlineCode>{`.`}</li>\n      <li parentName=\"ul\">{`Fetch colos analytics for `}<inlineCode parentName=\"li\">{`ZONE_ID`}</inlineCode>{` with a time range that starts on\n`}<inlineCode parentName=\"li\">{`2020-12-10T00:00:00Z`}</inlineCode>{` (`}<inlineCode parentName=\"li\">{`since`}</inlineCode>{` paramenter) to now.`}</li>\n    </ul>\n    <p>{`The question that we want to answer is: \"what is the number of requests for ZHR\nper hour?\" Using the colos endpoint response data and some wrangling by jq we\ncan answer that question with this command:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`cat colos_endpoint_output.json | jq  -c '.result[] | {colo_id: .colo_id, timeseries: .timeseries[]} | {colo_id: .colo_id, timeslot: .timeseries.since, requests: .timeseries.requests.all, bandwidth: .timeseries.bandwidth.all} | select(.requests > 0) | select(.colo_id == \"ZRH\") '\n`}</code></pre>\n    <p>{`This jq command is a bit of a mouthful, so let's break it down:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`.result[]\n`}</code></pre>\n    <p>{`This means \"break out the result array into individual json lines\"`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`{colo_id: .colo_id, timeseries: .timeseries[]}\n`}</code></pre>\n    <p>{`This breaks out each json line into multiple json lines. Each resulting line\ncontains a `}<inlineCode parentName=\"p\">{`colo_id`}</inlineCode>{` and one element of the `}<inlineCode parentName=\"p\">{`timeseries`}</inlineCode>{` array. `}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`{colo_id: .colo_id, timeslot: .timeseries.since, requests: .timeseries.requests.all, bandwidth: .timeseries.bandwidth.all}\n`}</code></pre>\n    <p>{`This flattens out the data we are interested in that is inside the timeseries\nobject of each line.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`select(.requests > 0) | select(.colo_id == \"ZRH\")\n`}</code></pre>\n    <p>{`This selects only lines that contain more than 0 requests and the `}<inlineCode parentName=\"p\">{`colo_id`}</inlineCode>{` is ZRH.`}</p>\n    <p>{`So the final data we get looks something like this:`}</p>\n    <details>\n      <summary>Response</summary>\n      <div>\n        <pre><code parentName=\"pre\" {...{\n            \"className\": \"language-json\"\n          }}>{`{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T00:00:00Z\",\"requests\":601,\"bandwidth\":683581}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T01:00:00Z\",\"requests\":484,\"bandwidth\":550936}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T02:00:00Z\",\"requests\":326,\"bandwidth\":370627}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T03:00:00Z\",\"requests\":354,\"bandwidth\":402527}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T04:00:00Z\",\"requests\":446,\"bandwidth\":507234}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T05:00:00Z\",\"requests\":692,\"bandwidth\":787688}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T06:00:00Z\",\"requests\":1474,\"bandwidth\":1676166}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T07:00:00Z\",\"requests\":2839,\"bandwidth\":3226871}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T08:00:00Z\",\"requests\":2953,\"bandwidth\":3358487}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T09:00:00Z\",\"requests\":2550,\"bandwidth\":2901823}\n{\"colo_id\":\"ZRH\",\"timeslot\":\"2020-12-10T10:00:00Z\",\"requests\":2203,\"bandwidth\":2504615}\n...\n`}</code></pre>\n      </div>\n    </details>\n    <p>{`So, how do we do the same thing using the GraphQL API?`}</p>\n    <p>{`The GraphQL API allows us to be much more specific about the data that we want\nto retrieve. While the colos endpoint forces us to retrieve all the information\nis has about the breakdown of requests and bandwidth per colo, using the\nGraphQL API allows us to fetch only the information we are interested in.`}</p>\n    <p>{`The data we want is about HTTP requests. Hence, we use the canonical source for\nHTTP request data, also known as `}<inlineCode parentName=\"p\">{`httpRequestsAdaptiveGroups`}</inlineCode>{`. This node in\nGraphQL API allows you to filter and group by almost any dimension of an http\nrequest imaginable. It is \"Adaptive\" so responses will be fast since it is\ndriven by our\n`}<a parentName=\"p\" {...{\n        \"href\": \"https://blog.cloudflare.com/explaining-cloudflares-abr-analytics/\"\n      }}>{`\"ABR\" technology`}</a>{`.`}</p>\n    <p>{`Let's craft a GraphQL API query to retrieve the data we need to answer the\nquestion: \"what is the number of requests for ZHR per hour?\" `}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-text\"\n      }}>{`{\n  viewer {\n    zones(filter: {zoneTag:\"$ZONE_TAG\"}) {\n      httpRequestsAdaptiveGroups(filter: {datetime_gt: \"2020-12-10T00:00:00Z\", coloCode:\"ZRH\"}, limit:10000, orderBy: [datetimeHour_ASC]) {\n        count\n        sum {\n          edgeResponseBytes\n        }\n        avg {\n          sampleInterval\n        }\n        count\n        dimensions {\n          datetimeHour\n          coloCode\n        }\n      }\n    }\n  }\n}\n`}</code></pre>\n    <p>{`Then we can run it with \"curl\":`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`curl -X POST -H 'Authorization: Bearer $API_TOKEN'  https://api.cloudflare.com/client/v4/graphql -d \"@./coloGroups.json\" > graphqlColoGroupsResponse.json\n`}</code></pre>\n    <p>{`We can answer our question in the same way as before using jq:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`cat graphqlColoGroupsResponse.json| jq -c '.data.viewer.zones[] | .httpRequestsAdaptiveGroups[] | {colo_id: .dimensions.coloCode, timeslot: .dimensions.datetimeHour, requests: .count, bandwidth: .sum.edgeResponseBytes}'\n`}</code></pre>\n    <p>{`This command is much simpler than what we had before, because the data returned\nby the GraphQL API is much simpler than what is returned by the colos endpoint.`}</p>\n    <p>{`Still, it is worth explaining the command since it will help to understand some\nof the concepts underlying the GraphQL API.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`.data.viewer.zones[]\n`}</code></pre>\n    <p>{`The format of a GraphQL response is much the same as the query. A successful\nresponse always contains a \"data\" object which wraps the data in the response.\nA query will always have a \"viewer\" object which represents your user. Then, we\nunwrap the zones objects, one per line. Our query only has one zone (since this\nis how we chose to do it). But a query could have multiple zones as well. `}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`.httpRequestsAdaptiveGroups[]\n`}</code></pre>\n    <p>{`The httpRequestsAdaptiveGroups field is a list, where each datapoint in the\nlist represents a combination of the dimensions that were selected, along with\nthe aggregation that was selected for that combination of the dimensions. Here,\nwe unwrap each of the datapoints, one per row.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`{colo_id: .dimensions.coloCode, timeslot: .dimensions.datetimeHour, requests: .count, bandwidth: .sum.edgeResponseBytes}\n`}</code></pre>\n    <p>{`This is straightforward: it just selects the attributes of each datapoint that\nwe are interested in, in the format which we used previously in the colos\nendpoint.`}</p>\n    <p>{`The GraphQL API is so much more powerful than this, though. You can filter and\ngroup the data by any dimensions you can think of. This feature is totally\nabsent from the colos endpoint in the Zone Analytics API.`}</p>\n\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;"}}
{"data":{"mdx":{"id":"b1ffa2fd-e4b5-5923-a8f4-023c598d0de4","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"pcx-content-type\": \"configuration\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar Aside = makeShortcode(\"Aside\");\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", {\n    \"id\": \"require-a-valid-hmac-token\"\n  }, \"Require a valid HMAC token\"), mdx(Aside, {\n    type: \"warning\",\n    header: \"Important\",\n    mdxType: \"Aside\"\n  }, mdx(\"p\", null, \"Access to the HMAC validation function requires a Cloudflare Pro, Business, or Enterprise plan.\")), mdx(\"h2\", {\n    \"id\": \"hmac-token-validation\"\n  }, \"HMAC token validation\"), mdx(\"p\", null, \"Use the Rules language \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developers.cloudflare.com/ruleset-engine/rules-language/functions#hmac-validation\"\n  }, \"HMAC validation function\"), \" to validate hash-based message authentication code (HMAC) tokens in a Firewall Rules expression.\"), mdx(\"p\", null, \"This example uses HMAC token authentication to protect a static private asset hosted by \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"example.com\"), \".\"), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http.request.uri\"), \" for this example is\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-txt\"\n  }, \"/download/cat.jpg?verify=1484063787-9JQB8vP1z0yc5DEBnH6JGWM3mBmvIeMrnnxFi3WtJLE%3D\\n\")), mdx(\"p\", null, \"where\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/download/cat.jpg?\"), \" represents the path to the asset\\u2014the HMAC \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"message\"), \" to authenticate\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"?verify=\"), \" is the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"separator\"), \" between the path to the asset and the timestamp when the HMAC token was issued\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"1484063787\"), \" represents the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"timestamp when the token was issued\"), \", expressed as Unix time in seconds\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"9JQB8vP1z0yc5DEBnH6JGWM3mBmvIeMrnnxFi3WtJLE%3D\"), \" is a base64-encoded \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"MAC\")))), mdx(\"p\", null, \"The Firewall Rule below blocks requests to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"example.com\"), \" that do not include a valid HMAC.\"), mdx(\"p\", null, \"The rule supplies the value of the secret key shared between the website and Cloudflare as the first argument to the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developers.cloudflare.com/ruleset-engine/rules-language/functions#hmac-validation\"\n  }, \"HMAC validation function\"), \", and it uses the value of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http.request.uri\"), \" for the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developers.cloudflare.com/ruleset-engine/rules-language/functions#messagemac\"\n  }, \"MessageMAC\"), \":\"), mdx(\"table\", null, mdx(\"thead\", null, mdx(\"tr\", null, mdx(\"th\", null, \"Expression\"), mdx(\"th\", null, \"Action\"))), mdx(\"tbody\", null, mdx(\"tr\", null, mdx(\"td\", null, mdx(\"code\", null, \"http.host eq \\\"downloads.example.com\\\" and not is_timed_hmac_valid_v0(\\\"secretKey\\\", http.request.uri, 10800, http.request.timestamp.sec,8)\")), mdx(\"td\", null, mdx(\"em\", null, \"Block\"))))), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"is_timed_hmac_valid()\"), \" function compares the value of a MAC generated using \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"secretKey\"), \" to the value encoded in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http.request.uri\"), \".\"), mdx(\"p\", null, \"If the MAC values match and\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-txt\"\n  }, \"http.request.timestamp.sec < (timestamp-issued + 10800)\\n\")), mdx(\"p\", null, \"then the token is valid and the function returns \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"true\"), \".\"), mdx(\"p\", null, \"Since the expression in this example uses the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"not\"), \" operator, it only matches when the HMAC token is \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"not\"), \" valid. When the token is not valid, the Cloudflare triggers the action and blocks the request.\"), mdx(Aside, {\n    type: \"warning\",\n    header: \"Important\",\n    mdxType: \"Aside\"\n  }, mdx(\"p\", null, \"When you do not use the optional \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"flags\"), \" argument for \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"_is_timed_hmac_valid()\"), \", you must URL encode the base64 value for \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"mac\"), \" in the \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"MessageMAC\"), \" argument.\"), mdx(\"p\", null, \"For more information, refer to \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developers.cloudflare.com/ruleset-engine/rules-language/functions#hmac-validation\"\n  }, \"Functions: HMAC Validation\"), \".\")), mdx(\"h2\", {\n    \"id\": \"use-the-same-secret-key-to-protect-multiple-paths\"\n  }, \"Use the same secret key to protect multiple paths\"), mdx(\"p\", null, \"You can use the same secret key to protect multiple URI paths.\"), mdx(\"p\", null, \"This is illustrated in the example above, where \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http.request.uri\"), \" is passed as the MessageMAC argument to the validation function.\"), mdx(\"p\", null, \"Since \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http.request.uri\"), \" includes the path to the asset and that value is extracted for each request, the validation function evaluates all request URIs to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"downloads.example.com\"), \" using the same secret key.\"), mdx(\"p\", null, \"Note that while you can use the same secret key to authenticate multiple paths, you must generate an HMAC token for each unique message you want to authenticate.\"));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"demo":null,"difficulty":null,"summary":null,"tags":null,"title":"","type":null,"updated":null}}},"pageContext":{"id":"b1ffa2fd-e4b5-5923-a8f4-023c598d0de4","fields":{"slug":"/recipes/require-valid-hmac-token"},"frontmatter":{"title":"","type":null,"order":null,"hidden":null,"hideChildren":null,"breadcrumbs":null},"headings":[{"value":"Require a valid HMAC token","depth":1}],"tableOfContents":{"items":[{"url":"#require-a-valid-hmac-token","title":"Require a valid HMAC token","items":[{"url":"#hmac-token-validation","title":"HMAC token validation"},{"url":"#use-the-same-secret-key-to-protect-multiple-paths","title":"Use the same secret key to protect multiple paths"}]}]},"parent":{"modifiedTime":"2022-02-09","relativePath":"recipes/require-valid-hmac-token.md"}}}